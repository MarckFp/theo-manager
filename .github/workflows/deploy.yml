name: 'Deploy ðŸš€'

on:
  push:
    tags:
      - '*.*.*'

#For NDK see: https://developer.android.com/ndk/downloads
env:
  GH_TOKEN: ${{ github.token }}
  NDK_VERSION: "29.0.14206865"
  DX_VERSION: "0.7.1"

jobs:
  deploy:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
      contents: write
      discussions: write
    strategy:
      fail-fast: false
      matrix:
        include:
        # Windows
          - name: 'Windows x86 ðŸªŸ'
            os: 'windows-2025'
            target: 'i686-pc-windows-msvc'
            platform: desktop
          - name: 'Windows x64 ðŸªŸ'
            os: 'windows-2025'
            target: 'x86_64-pc-windows-msvc'
            platform: desktop
          - name: 'Windows ARM64 ðŸªŸ'
            os: 'windows-2025'
            target: 'aarch64-pc-windows-msvc'
            platform: desktop
          # MacOS
          - name: 'MacOS x64 ðŸ'
            os: 'macos-26'
            target: 'x86_64-apple-darwin'
            platform: desktop
          - name: 'MacOS ARM64 ðŸ'
            os: 'macos-26'
            target: 'aarch64-apple-darwin'
            platform: desktop
          # Linux
          - name: 'Linux x64 ðŸ§'
            os: 'ubuntu-24.04'
            target: 'x86_64-unknown-linux-gnu'
            platform: desktop
          - name: 'Linux ARM64 ðŸ§'
            os: 'ubuntu-24.04-arm'
            target: 'aarch64-unknown-linux-gnu'
            platform: desktop
          # Android
          - name: 'Android APKðŸ¤–'
            os: 'macos-26'
            target: 'aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android'
            platform: android
          - name: 'Android AABðŸ¤–'
            os: 'macos-26'
            target: 'aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android'
            platform: android
          # iOS
          - name: 'iOS ðŸ“±'
            os: 'macos-26'
            target: 'aarch64-apple-ios aarch64-apple-ios-sim'
            platform: ios
          # Web
          - name: 'Web ðŸŒ'
            os: 'ubuntu-24.04'
            target: 'wasm32-unknown-unknown'
            platform: web
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v5

      - name: Set version ðŸ“
        shell: bash
        env:
          RELEASE_TAG: ${{ github.ref_name }}
        run: |
          mv Cargo.toml Cargo.toml.orig
          sed "s/0\\.0\\.0-git/${RELEASE_TAG##*\/v}/" Cargo.toml.orig >Cargo.toml

      - name: Setup Rust Targets ðŸ¦€
        run: rustup target add ${{ matrix.target }}

      - name: Setup Java â˜•
        if: ${{ matrix.platform == 'android'}}
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: Setup Android ðŸ¤–
        if: ${{ matrix.platform == 'android'}}
        uses: android-actions/setup-android@v3

      - name: Install Cargo Binstall ðŸ› ï¸
        uses: cargo-bins/cargo-binstall@main

      - name: Setup Dependencies & Configs ðŸ› ï¸
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

          case "${{ runner.os }}" in
            "Linux")
              sudo apt update -y
              sudo apt install build-essential librsvg2-dev -y

              if [[ "${{ matrix.platform }}" != 'web' ]]; then
                sudo apt install libwebkit2gtk-4.1-dev libxdo-dev libglib2.0-dev libayatana-appindicator3-dev -y
              fi
          esac

          case "${{ matrix.platform }}" in
            "android")
              sdkmanager "ndk;$NDK_VERSION"
              ;;
          esac

          cargo binstall dioxus-cli --version $DX_VERSION -y

      - name: Build & Deploy ${{ matrix.name }} ðŸš€
        shell: bash
        run: |
          case "${{ matrix.platform }}" in
            "desktop")
              dx bundle --release --platform ${{ matrix.platform }} --target ${{ matrix.target }} --features bundle
              ;;

            "android")
              case "${{ matrix.name }}" in
                "Android APKðŸ¤–")
                  dx build --release --platform ${{ matrix.platform }}
                  ;;

                "Android AABðŸ¤–")
                  dx bundle --release --platform ${{ matrix.platform }} --features bundle
                  ;;
              esac
              ;;

            "ios")
              dx bundle --release --platform ${{ matrix.platform }} --features bundle
              ;;

            "web")
              dx bundle --release --platform ${{ matrix.platform }} --features bundle --base-path ${{ github.event.repository.name }}
              ;;
          esac

          if [[ "${{ matrix.platform }}" == "web" ]]; then
            cp target/dx/${{ github.event.repository.name }}/release/web/public/index.html target/dx/${{ github.event.repository.name }}/release/web/public/404.html
          fi

      - name: Optimize Wasm âš¡
        if: ${{ matrix.platform == 'web'}}
        uses: NiklasEi/wasm-opt-action@v2
        with:
          file: target/dx/${{ github.event.repository.name }}/release/web/public/wasm/*.wasm
          optimize_all: true
          options: -Oz

      - name: Upload Github Pages ðŸ“¤
        if: ${{ matrix.platform == 'web'}}
        uses: actions/upload-pages-artifact@v4
        with:
          path: target/dx/${{ github.event.repository.name }}/release/web/public/

      - name: Deploy Github Pages ðŸŒ
        if: ${{ matrix.platform == 'web' }}
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Install UPX ðŸ› ï¸
        if: ${{ matrix.platform == 'desktop' && matrix.name != 'MacOS x64 ðŸ' && matrix.name != 'MacOS ARM64 ðŸ'}}
        uses: crazy-max/ghaction-upx@v3
        with:
          install-only: true

      - name: Upload Artifacts ðŸ“¦
        if: ${{ matrix.platform != 'web' }}
        shell: bash
        run: |
          case "${{ matrix.name }}" in
            "Windows x86 ðŸªŸ")
              upx --best target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/nsis/TheoManager_${{ github.ref_name }}_x86-setup.exe
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/msi/TheoManager_${{ github.ref_name }}_x86_en-US.msi \
                target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/nsis/TheoManager_${{ github.ref_name }}_x86-setup.exe
              ;;
            "Windows x64 ðŸªŸ")
              upx --best target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/nsis/TheoManager_${{ github.ref_name }}_x64-setup.exe
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/msi/TheoManager_${{ github.ref_name }}_x64_en-US.msi \
                target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/nsis/TheoManager_${{ github.ref_name }}_x64-setup.exe
              ;;

            "Windows ARM64 ðŸªŸ")
              upx --best target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/nsis/TheoManager_${{ github.ref_name }}_arm64-setup.exe
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/msi/TheoManager_${{ github.ref_name }}_arm64_en-US.msi \
                target/dx/${{ github.event.repository.name }}/bundle/windows/bundle/nsis/TheoManager_${{ github.ref_name }}_arm64-setup.exe
              ;;

            "Linux x64 ðŸ§")
              upx --best target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/appimage/TheoManager_${{ github.ref_name }}_amd64.AppImage
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/deb/TheoManager_${{ github.ref_name }}_amd64.deb \
                target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/rpm/TheoManager-${{ github.ref_name }}-.x86_64.rpm \
                target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/appimage/TheoManager_${{ github.ref_name }}_amd64.AppImage
              ;;

            "Linux ARM64 ðŸ§")
              upx --best target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/appimage/TheoManager_${{ github.ref_name }}_aarch64.AppImage
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/deb/TheoManager_${{ github.ref_name }}_arm64.deb \
                target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/rpm/TheoManager-${{ github.ref_name }}-.aarch64.rpm \
                target/dx/${{ github.event.repository.name }}/bundle/linux/bundle/appimage/TheoManager_${{ github.ref_name }}_aarch64.AppImage
              ;;

            "MacOS x64 ðŸ")
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/macos/bundle/dmg/TheoManager_${{ github.ref_name }}_x64.dmg
              ;;

            "MacOS ARM64 ðŸ")
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/bundle/macos/bundle/dmg/TheoManager_${{ github.ref_name }}_aarch64.dmg
              ;;

            "iOS ðŸ“±")
              mkdir Payload
              mv target/dx/${{ github.event.repository.name }}/release/ios/TheoManager.app Payload/
              zip -r TheoManager_${{ github.ref_name }}.ipa Payload
              gh release upload ${{ github.ref_name }} TheoManager_${{ github.ref_name }}.ipa
              ;;

            "Android APKðŸ¤–")
              mv target/dx/${{ github.event.repository.name }}/release/android/app/app/build/outputs/apk/debug/app-debug.apk target/dx/${{ github.event.repository.name }}/release/android/app/app/build/outputs/apk/debug/TheoManager_${{ github.ref_name }}.apk
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/release/android/app/app/build/outputs/apk/debug/TheoManager_${{ github.ref_name }}.apk
              ;;

            "Android AABðŸ¤–")
              mv target/dx/${{ github.event.repository.name }}/release/android/app/app/build/outputs/bundle/release/TheoManager-aarch64-linux-android.aab target/dx/${{ github.event.repository.name }}/release/android/app/app/build/outputs/bundle/release/TheoManager_${{ github.ref_name }}.aab
              gh release upload ${{ github.ref_name }} target/dx/${{ github.event.repository.name }}/release/android/app/app/build/outputs/bundle/release/TheoManager_${{ github.ref_name }}.aab
              ;;
          esac
  release:
    name: 'Release Notes ðŸ“'
    runs-on: ubuntu-24.04
    needs: deploy
    permissions:
      id-token: write
      contents: write
      discussions: write
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v5

      - name: Create Release Notes ðŸ“
        run: |
          echo "## Release ${{ github.ref_name }}" >> release_notes.md
          echo "### Changelog:" >> release_notes.md
          PREV_TAG=$(gh release list --limit 2 --json tagName --jq '.[1].tagName')
          if [ -n "$PREV_TAG" ]; then
            echo "[Full Changelog](https://github.com/MarckFp/${{ github.event.repository.name }}/compare/${PREV_TAG}...${{ github.ref_name }})" >> release_notes.md
          fi
          echo "" >> release_notes.md
          echo "### Desktop Apps:" >> release_notes.md
          echo "- [Windows x86 ðŸªŸ](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_x86-setup.exe)" >> release_notes.md
          echo "- [Windows x64 ðŸªŸ](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_x64-setup.exe)" >> release_notes.md
          echo "- [Windows ARM64 ðŸªŸ](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_arm64-setup.exe)" >> release_notes.md
          echo "- [MacOS x64 ðŸ](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_x64.dmg)" >> release_notes.md
          echo "- [MacOS ARM64 ðŸ](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_arm64.dmg)" >> release_notes.md
          echo "- [Linux x64 ðŸ§](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_x64.AppImage)" >> release_notes.md
          echo "- [Linux ARM64 ðŸ§](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}_arm64.AppImage)" >> release_notes.md
          echo "### Mobile Apps:" >> release_notes.md
          echo "- [iOS ðŸ“±](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}.ipa)" >> release_notes.md
          echo "- [Android APK ðŸ¤–](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}.apk)" >> release_notes.md
          echo "- [Android AAB ðŸ¤–](https://github.com/MarckFp/${{ github.event.repository.name }}/releases/download/${{ github.ref_name }}/TheoManager_${{ github.ref_name }}.aab)" >> release_notes.md
          echo "### Web App:" >> release_notes.md
          echo "- [Web ðŸŒ](https://marckfp.github.io/${{ github.event.repository.name }}/)" >> release_notes.md
          gh release edit ${{ github.ref_name }} --notes-file release_notes.md
